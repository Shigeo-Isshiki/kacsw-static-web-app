# phone-utils 使い方リファレンス

このドキュメントは `src/phone-utils.js` が公開する電話番号ユーティリティ関数の使い方、契約（引数・戻り値・副作用）をまとめたリファレンスです。

---

## 概要

`src/phone-utils.js` は日本国内の電話番号（固定電話、携帯、フリーダイヤル、IP 電話、M2M 等）を扱うためのユーティリティ群です。主に次を提供します:

- 電話番号の正規化（記号・全角数字の除去）
- 電話番号の妥当性検証（日本国内ルールに基づく）
- 電話番号のハイフン付きフォーマット
- 電話番号の種別判定（固定電話 / 携帯 / 着信課金 等）

ライブラリは Node（jsdom 等）とブラウザの両方で使えるよう設計されています。ブラウザではファイル末尾で `window` に関数を非破壊的に公開します。

---

## 公開 API サマリ

- `isValidPhoneNumber(phoneNumber)`
- `formatPhoneNumber(phoneNumber)`
- `getPhoneNumberType(phoneNumber)`
- `normalizePhoneNumber(phoneNumber)`

（全て同期関数、入力に不正がある場合は `Error` をスローします。`phoneNumber` は文字列または数値を受け取ります。）

---

## 各関数の詳細

### `isValidPhoneNumber(phoneNumber)`

- 概要: 与えられた値が日本国内で有効とみなせる電話番号かを判定します。
- 引数: `phoneNumber` (string|number) — 任意の記号や全角数字を含む文字列も可。
- 戻り値: `boolean` — 有効なら `true`、無効なら `false` を返します。
- 例外: 入力が空や不正な場合は `Error` を投げることがあります（呼び出し側で try/catch 推奨）。

動作メモ:

- 国番号（+81）や `+` で始まるものは無効として扱います。
- 市外局番ごとの範囲や桁数ルールを参照して厳密に判定します（例: `03` 系は 10 桁固定、`080` は 11 桁、`0200` は 14 桁など）。

テストヒント: 無効値、全角数字やハイフンを含む入力、`091` 系の特殊番号（6〜13 桁）などで境界ケースを確認してください。

### `formatPhoneNumber(phoneNumber)`

- 概要: 電話番号を正規化（記号・全角→半角化）し、ハイフン付きの表記と判定結果などの属性を含むオブジェクトを返します。
- 引数: `phoneNumber` (string|number)
- 戻り値: `Object` — 次のプロパティを含みます:
  - `formattedNumber` {string} : ハイフン付きで整形された電話番号（例: `03-1234-5678`）
  - `type` {string} : 判定された電話番号の種類（例: `'固定電話'`, `'携帯電話'` 等）
  - `callCapable` {boolean} : 通話可能かどうか
  - `homeLine` {boolean} : 固定回線（自宅向け）かどうか
  - `faxCapable` {boolean} : FAX に適した回線かどうか
  - `mobile` {boolean} : 携帯電話かどうか
- 例外: 無効な入力は `Error` を投げます。

動作メモ:

- `091` で始まる 6～13 桁の番号は `091-xxxx...` の形式で必ず 3 桁プレフィックスを分離します。
- 種別に応じてハイフン分割パターンを決定します（固定電話は市外局番→市内局番→加入者番号、携帯は 3-4-4 等）。

### `getPhoneNumberType(phoneNumber)`

- 概要: 電話番号の種別（文字列）を返します。
- 引数: `phoneNumber` (string|number)
- 戻り値: `string` — 代表的な戻り値例:
  - `'固定電話'`, `'携帯電話'`, `'着信課金'`, `'統一番号'`, `'IP電話'`, `'M2M'`, `'無線呼出'`, `'FMC'`, `'特定接続'`, `'付加サービス'`, `'不明'`
- 例外: 無効な入力は `Error` を投げます。

動作メモ:

- 内部では桁数（10/11/14 等）と市外局番プレフィックスの組み合わせ、`digit11PhoneNumberRange` などの設定を参照して判定します。

#### 戻り値（電話番号の種類）一覧

`formatPhoneNumber` と `getPhoneNumberType` が返す電話番号の種類（`type`）は同じ語彙を使います。代表的な戻り値と意味は次のとおりです。

- `固定電話` — 一般の市外局番を持つ固定回線（例: `03-1234-5678`）。通常は 10 桁の番号。
- `携帯電話` — 携帯電話番号（070/080/090 等）。主に 11 桁で判定される。
- `着信課金` — 利用者が受信時に料金を負担する番号（例: `0120` はフリーダイヤル扱いだが実装上は着信課金として扱う挙動があるため注意）。
- `統一番号` — 0570（ナビダイヤル等）のような統一番号サービス。
- `IP電話` — IP 電話（プレフィックス 050 等）。
- `M2M` — M2M（マシン・トゥ・マシン）用途の番号（例: `020` / `0200` 系等、11/14 桁扱いのものがある）。
- `無線呼出` — 無線呼出や無線サービスに割当てられた番号（`digit11PhoneNumberRange` の `wireless` 等に該当するもの）。
- `FMC` — FMC（例: `0600` 等、特定の 11 桁扱いプレフィックス）。
- `特定接続` — 091 で始まる 6〜13 桁の特殊接続番号など、固有ルールで扱う番号。
- `付加サービス` — 付加的なサービス番号や 10 桁で着信課金/統一番号に該当しない場合の分類。
- `不明` — 上記いずれにも該当しない、判定できない番号。

各語彙は実装中の `_PU_PHONE_NUMBER_CONFIG` の設定（`digit11PhoneNumberRange` / `notLandlinePhoneNumberRange` / `areaCodeRanges` 等）に依存します。新たなプレフィックス追加やルール変更時は該当設定を更新してください。

### `normalizePhoneNumber(phoneNumber)`

- 概要: 電話番号を半角数字のみの文字列に正規化して返します（ハイフンや空白、全角数字を除去）。
- 引数: `phoneNumber` (string|number)
- 戻り値: `string` — 数字のみの形式（例: `0312345678`）。
- 例外: 無効な電話番号の場合は `Error` を投げます。

用途:

- フォーム保存前や比較処理用に「数字のみ」表現が必要な場合に利用します。

---

## 例

```js
// ブラウザでロードされた場合、window にエクスポートされます
// Node テストでは require した後に global.window = global として利用できます

isValidPhoneNumber('03-1234-5678'); // -> true
// formatPhoneNumber はオブジェクトを返します
formatPhoneNumber('０３ １２３４ ５６７８'); // -> { formattedNumber: '03-1234-5678', type: '固定電話', callCapable: true, homeLine: true, faxCapable: true, mobile: false }
getPhoneNumberType('080-1234-5678'); // -> '携帯電話'
normalizePhoneNumber('(080)-1234-5678'); // -> '08012345678'
```

---

## テストヒント

- `091` 系の長さ境界（6・13 桁）を確認する。
- 011/03/06 系など市外局番の境界ケース、`0120`/`0800` などの着信課金・フリーダイヤルの扱いを確認する。
- 全角数字・全角スペース・各種括弧・スラッシュなどの記号を含む入力で正規化とバリデーションの整合性を検証する。

---

必要なら各内部設定（`_PU_PHONE_NUMBER_CONFIG`）の解説や、具体的な範囲ルール（`areaCodeRanges` / `digit11PhoneNumberRange`）の読み方を追記します。どの部分を掘り下げますか？

```

---

## 総務省の電話番号データが更新されたときに修正すべき点

総務省（あるいは同等の公式データ）が電話番号の割当や範囲を更新した場合、`src/phone-utils.js` 内のデータと挙動を最新化する必要があります。以下は短く実務的にやるべき項目です。

- **更新対象データ**:
  - `/_PU_PHONE_NUMBER_CONFIG.areaCodeList`（市外局番ごとの市内局番桁数）
  - `/_PU_PHONE_NUMBER_CONFIG.areaCodeRanges`（市内局番の範囲指定）
  - `/_PU_PHONE_NUMBER_CONFIG.digit11PhoneNumberRange`（11桁扱いのプレフィックス群）
  - `/_PU_PHONE_NUMBER_CONFIG.notLandlinePhoneNumberRange`（固定電話扱い除外プレフィックス）
  - 併せて `callCapableTypes` / `faxExcludedTypes` / `mobileType` 等の判定ルールを見直す

- **実務手順（推奨）**:
  1. 総務省公開データ（または提供元の公式リリース）を入手し、差分を確認する。
  2. 上記の各フィールドへ新しい値を反映する。複数桁長（2/3/4/5 など）のキー配列は降順ソートで扱われるため、追加・削除後にソート順を保つ。
  3. ファイル先頭のバージョン表記（ヘッダコメント）や `@version` を更新してリリース履歴を残す。
  4. ローカルキャッシュ（`_pu_areaCodeListCache`）の初期値が残る場合があるため、デプロイ/再起動前にキャッシュを再生成するか、実行時に `null` にリセットする処置を検討する。

- **検証（必須）**:
  - 単体テストを追加／更新する:
    - 変更された市外局番について、正しいハイフンパターンが返るか (`formatPhoneNumber`) を確認する。
    - その市外局番での有効／無効判定（`isValidPhoneNumber`）を多数の正常系/異常系ケースで検証する。
    - `getPhoneNumberType` の出力が期待どおりか（例: 新たなプレフィックスが 11 桁扱いになる場合など）を確認する。
  - 既存のテスト（`test/` ディレクトリ）を実行して回帰がないことを確認する: `node test/run-tests.js` など。

- **注意点 / エッジケース**:
  - 一部プレフィックス（例: `0200` のような M2M、`0800`/`0120` 等の着信課金）は桁数ルールが他と異なるため、単純な桁数チェックだけでは不十分。`digit11PhoneNumberRange` の設定と `areaCodeRanges` の組み合わせを必ず確認する。
  - `areaCodeRanges` の表記（`"20-30,35,40-50"` 形式）は正しくパースされる必要があるため、取り込むデータがこの仕様に沿っているか検査する。
  - データ更新によって `formatPhoneNumber` のハイフン位置や `isValidPhoneNumber` の判定結果が変わるため、外部に保存している正規化済み値（DB 等）があれば影響範囲を検討する。

- **運用メモ**:
  - データ差分を管理するための小さなスクリプト（CSV/JSON → `src/phone-utils.js` の該当オブジェクトへ変換）を用意しておくと人的ミスが減ります。将来的には `data/` ディレクトリへ生データを置き、ビルド時に取り込む仕組みも検討してください。
  - 変更点は `CHANGELOG.md`（リポジトリルート）やコミットメッセージに明確に書き残すと QA が楽になります。

---
```
